pipeline {
    agent any

    stages {
        stage('Execute Script') {
            steps {
                script {
                    // Specify the path to your local Jenkinsfile
                    def scriptPath = '/home/ubuntu/jenkinscript1.sh'
                    def logFilePath = '/tmp/jenkins.log'

                    // Get the current timestamp
                    def timestamp = sh(script: "date '+%Y-%m-%d %H:%M:%S'", returnStdout: true).trim()

                    // Execute the Jenkinsfile and append output with timestamp to the log file
                    sh "sudo bash ${scriptPath} >> ${logFilePath} 2>&1"
                    sh "sudo echo '${timestamp} - Script execution completed.' >> ${logFilePath}"

                    // Print the current log file content for debugging (optional)
                    echo "Current Script Output:"
                    def currentScriptOutput = sh(script: "tail -n 11 ${logFilePath}", returnStdout: true).trim()
                    echo currentScriptOutput

                    // Send success notification to Telegram with the current content
                    sendTelegramNotification(currentScriptOutput)
                }
            }
        }

        stage('Success Notification') {
            when {
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                script {
                    // Send a test message to Telegram
                    sendTelegramNotification("Jenkins Job Completed Successfully. Logging Results Saved.")
                    sendTelegramNotification("Router Status : UP")
                }
            }
        }
    }
}

// Define the sendTelegramNotification function outside the pipeline block
def sendTelegramNotification(msg) {
    // Send the message to Telegram
    sh "curl -X POST -H 'Content-Type: application/json' -d '{\"chat_id\": \"2120613878\", \"text\": \"$msg\", \"disable_notification\": true}' https://api.telegram.org/bot6964667296:AAF8Bv8XibWEPeQ4CQCL5htOfEVJTrffhHs/sendMessage"
}

